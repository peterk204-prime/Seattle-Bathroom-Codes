<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Seattle Bathroom Finder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        *{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          height: 100vh;
          overflow: hidden;
        }
/* map takes up the page */
      #map {
          height: 100vh;
          width: 100%;
      }
/*header box */
        .header {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99999;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            text-align: center;
        }
/*words in header*/
        .header h1 {
            font-size: 24px;
            color: black;
            margin-bottom: 5px;
        }
/*this baby is live format*/
        .header .status {
            font-size: 14px;
            color: black;
            font-weight: 500;
        }
/*control pannel stuff, do you want to see closed spots? */
        .controls {
            position: absolute;
            top: 100px;
            right: 10px;
            z-index: 99999;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow:0 2px 10px rgba(0,0,0,0.2);
            max-width: 200px;
        }
/*control panel words */
        .controls h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: black;
        }
/*checkbox and label*/
        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
    }
        .filter-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .filter-toggle label{
            font-size: 13px;
            cursor: pointer;
        }
/*which ones are open and closed, a number */
        .stats {
            font-size: 12px;
            color: black;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid black;
        }
/*all the info in the pop up box when u click */
        .leaflet-popup-content-wrapper{
            border-radius: 10px;
        }
        .popup-content h3 {
            margin: 0 0 10px 0;
            color: black;
            font-size: 18px;
        }
        .popup-content p {
            margin: 5px 0;
            font-size: 16px;
            color: black;
        }
/* make the bathroom code stand out*/
        .popup-content .code{
            background: blue;
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            display: inline-block;
            font-weight: bold;
            font-size: 20px;
            margin: 10px 0;
        }

/*talking about hours open in the popup*/
        .popup-content .hours {
            background: #BEBEBE;
            padding: 8px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 12px;
        }
         .popup-content .hours strong {
             color: white;
         }
/* legend stuff*/
        .legend {
            position: absolute;
            bottom: 20px;
            right: 10px;
            z-index: 999999;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(26, 25, 25, 0.2);
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;

        }
/*make that square a dot*/
        .legend-dot{
            width:12px;
            height: 12px;
            border-radius: 50%;
        }
        .open {background: green;}
        .closed {background: red;}
        
        /* Loading indicator */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 999999;
            font-size: 18px;
            font-weight: bold;
        }
        
    </style>

</head>
<body>

    <div id="loadingIndicator" class="loading">Loading bathrooms...</div>
    
    <div class="header">
        <h1>Seattle Bathroom Finder</h1>
        <div class="status" id="currentTime"></div>
    </div>

    <div class="controls">
        <h3>Filters</h3>
            <div class="filter-toggle">
                <input type="checkbox" id="showOpenOnly" checked>
                <label for="showOpenOnly">Show open only</label>
            </div>
            <div class="stats">
                <div><strong id="openCount">0</strong> open now</div> 
                <div><strong id="totalCount">0</strong> total</div>
            </div>
    </div>
    <div class="legend">
        <div class="legend-item">
            <div class="legend-dot open"></div>
            <span>Open Now</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot closed"></div>
            <span>Closed</span>
        </div>
    </div>
<div id="map"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
<script>
//THIS IS THE BATHROOM DATA - AUTO-LOADED FROM GOOGLE SHEETS
let bathrooms = []; // Start empty, will be filled from Google Sheet

// Google Sheet CSV URL
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRe1AnbqfbL1CgB-pvl9f-HgSE7cLGs3_glbsXmL0UXga1OjIM5QDLCAgTJ9tkleuhdhE4O8Z6JLapF/pub?output=csv'; 
    
// Function to parse CSV and convert to bathroom objects
function parseCSV(csv) {
    // Use PapaParse so quoted fields and commas are handled correctly.
    const parsed = Papa.parse(csv, { skipEmptyLines: true }).data;
    if (!parsed || parsed.length < 2) return [];

    const result = [];
    for (let i = 1; i < parsed.length; i++) {
        const values = parsed[i].map(v => (typeof v === 'string' ? v.trim().replace(/\r/g,'') : v));

        if (values.length < 4) continue;

        const lat = parseFloat(values[2]);
        const lng = parseFloat(values[3]);
        if (Number.isNaN(lat) || Number.isNaN(lng)) {
            console.warn(`Skipping row ${i+1} due to invalid lat/lng:`, values[2], values[3]);
            continue;
        }

        const bathroom = {
            name: values[0] || '',
            address: values[1] || '',
            lat: lat,
            lng: lng,
            code: values[4] || '',
            verified: values[5] || '',
            hours: {
                Mon: {
                    open1: values[6] || null,
                    close1: values[7] || null,
                    open2: values[8] || null,
                    close2: values[9] || null
                },
                Tue: {
                    open1: values[10] || null,
                    close1: values[11] || null,
                    open2: values[12] || null,
                    close2: values[13] || null
                },
                Wed: {
                    open1: values[14] || null,
                    close1: values[15] || null,
                    open2: values[16] || null,
                    close2: values[17] || null
                },
                Thu: {
                    open1: values[18] || null,
                    close1: values[19] || null,
                    open2: values[20] || null,
                    close2: values[21] || null
                },
                Fri: {
                    open1: values[22] || null,
                    close1: values[23] || null,
                    open2: values[24] || null,
                    close2: values[25] || null
                },
                Sat: {
                    open1: values[26] || null,
                    close1: values[27] || null,
                    open2: values[28] || null,
                    close2: values[29] || null
                },
                Sun: {
                    open1: values[30] || null,
                    close1: values[31] || null,
                    open2: values[32] || null,
                    close2: values[33] || null
                }
            }
        };
        result.push(bathroom);
    }
    return result;
}

// Load data from Google Sheets
async function loadBathroomData() {
    try {
        // Add a timestamp to bust caches and ask the browser not to use cached responses.
        const url = SHEET_URL + (SHEET_URL.includes('?') ? '&' : '?') + 't=' + Date.now();
        const response = await fetch(url, { cache: 'no-store' });
        if (!response.ok) throw new Error(`HTTP ${response.status} ${response.statusText}`);
        const csvText = await response.text();

        // Parse and only replace the data if parsing succeeded
        const parsedBathrooms = parseCSV(csvText);
        if (!Array.isArray(parsedBathrooms)) throw new Error('Parsed data is not an array');

        bathrooms = parsedBathrooms;
        console.log(`Loaded ${bathrooms.length} bathrooms from Google Sheets`);

        // Hide loading indicator if present
        const loadingEl = document.getElementById('loadingIndicator');
        if (loadingEl) loadingEl.style.display = 'none';

        // Update markers/time
        updateMarkers();
        updateTime();
    } catch (error) {
        console.error('Error loading bathroom data:', error);
        // Don't aggressively alert the user every interval; show a console message.
        const loadingEl = document.getElementById('loadingIndicator');
        if (loadingEl) loadingEl.textContent = 'Could not load bathroom data (see console)';
    }
}
//intilize the map
    const map = L.map('map').setView([47.6205, -122.3250], 13);
        
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];
//checking if bathroom is open now or not
    function isOpen(bathroom) {
        const now = new Date();
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const day = days[now.getDay()];
        const currentTime = now.getHours() * 100 + now.getMinutes();

        const todayHours = bathroom.hours[day];
        if (!todayHours || todayHours.open1 === 'Closed') return false

        if (todayHours.open1 && todayHours.close1) {
            const open1 = parseInt(todayHours.open1.replace(':',''));
            const close1 = parseInt (todayHours.close1.replace (':',''));
            if (currentTime >= open1 && currentTime <= close1 ) return true

        }

        if (todayHours.open2 && todayHours.close2) {
            const open2 = parseInt(todayHours.open2.replace(':',''));
            const close2 = parseInt (todayHours.close2.replace (':',''));
            if (currentTime >= open2 && currentTime <= close2 ) return true;

        }

        return false 

    }

    //formating how to display hours on popup

    function formatHours(bathroom){
        const now = new Date();
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const day = days[now.getDay()];
        const todayHours= bathroom.hours[day];
    
        if (!todayHours || todayHours.open1 === 'Closed') {
            return 'Closed Today';

        }

        let hoursText = `Today: ${todayHours.open1} - ${todayHours.close1}`;
        if (todayHours.open2 && todayHours.close2) {
            hoursText += `, ${todayHours.open2} - ${todayHours.close2}`;

        }
        return hoursText;
        
    }

    //popup content

    function createPopup(bathroom){
        const open= isOpen(bathroom);
        const status = open ? '<strong style=" color: green ;">OPEN NOW</strong>' : '<strong style="color: red ;">CLOSED</strong>';

        return ` 
            <div class="popup-content">
                <h3>${bathroom.name}</h3>
                <p>${bathroom.address}</p>
                <div class="code"> #${bathroom.code}</div>
                <div class="hours">
                    ${status}<br>
                    ${formatHours(bathroom)}
                </div>
                <p style= "margin-top: 10px; font-size: 11px; color: blue;">
                    Last verified: ${bathroom.verified}
                </p>

            </div>
        `;

    }

    //map markers

        function updateMarkers () {
            const showOpenOnly = document.getElementById('showOpenOnly').checked;

            markers.forEach(m => map.removeLayer(m));
            markers = [];

            let openCount=0;

            bathrooms.forEach(bathroom => {
                const open= isOpen(bathroom);
                if (open) openCount++;
                if (!showOpenOnly || open){
                    const icon=L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="
                        width:24px;
                        height: 24px;
                        background: ${open? 'green': 'red'};
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 5px rgba(0,0,0,.3);
                    "></div>`,
                    iconSize: [24,24]

                });

                const marker=L.marker([bathroom.lat, bathroom.lng], { icon })
                    .bindPopup(createPopup(bathroom))
                    .addTo(map);

                markers.push(marker);

                }
            });

            document.getElementById('openCount').textContent= openCount;
            document.getElementById('totalCount').textContent = bathrooms.length;

        }

        //time display
        
            function updateTime() {
                const now = new Date();
                const days= ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const timeStr = now.toLocaleTimeString ('en-US' , {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true

                });
            
                document.getElementById('currentTime').textContent= 
                    `${days[now.getDay()]}, ${timeStr} - Showing real-time availability`;
            }

            document.getElementById('showOpenOnly').addEventListener('change', updateMarkers);

            // Load data from Google Sheets on page load
            loadBathroomData();
            
            // Reload data every 5 minutes (in case sheet is updated)
            setInterval(() => {
                loadBathroomData();
            }, 300000); // 300000 ms = 5 minutes
            
            // Update time display every minute
            setInterval(() => {
                updateTime();
            }, 60000);
    </script>
</body>
</html>
